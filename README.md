````markdown
# CSV → Google Geocoding (batch)

Небольшой консольный скрипт на Python, который берёт CSV-файл с адресами и дописывает к ним координаты (широта/долгота), используя Google Maps Geocoding API.

Основной сценарий:
есть выгрузка вроде:

```csv
id,address
1,"Москва, ЦАО, Жуков пр-д (от Летниковской ул. до Дубининской ул.), д.19"
2,"Москва, ЦАО, Забелина ул. (пр. часть), пересечение со старосадским пер. д 11)"
...
````

На выходе получаем:

```csv
id,address,lat,lng
1,"Москва, ЦАО, Жуков пр-д (от Летниковской ул. до Дубининской ул.), д.19",55.726945,37.638346
2,"Москва, ЦАО, Забелина ул. (пр. часть), пересечение со старосадским пер. д 11)",55.7548814,37.6386081
...
```

---

## Возможности

* Пакетная геокодировка адресов из CSV.
* Поддержка русских адресов (читаем/пишем файл в кодировке `cp1251`, как Excel по умолчанию).
* Резервная логика: если `адрес` не находится целиком, скрипт **обрезает его по запятым справа**, пока не найдётся хоть что-нибудь
  (например, `"Москва, ЦАО, ... , д.19"` → `"Москва, ЦАО, ..."` → `"Москва, ЦАО"` → `"Москва"`).
* Поддержка нестандартного TLS (используется `verify=False`, чтобы пережить self-signed сертификаты).
* Пауза между запросами, чтобы не улететь в лимиты (`DELAY_SEC`).

---

## Требования

* Python 3.8+
* Библиотека `requests`

Установка зависимостей:

```bash
pip install requests
```

(или через `pipx`, Poetry — как тебе удобнее)

---

## Подготовка CSV

### Формат входного файла

По умолчанию скрипт ожидает файл `addresses.csv` в **той же папке**, где лежит скрипт.

Формат:

```csv
id,address
1,"Москва, ЦАО, Жуков пр-д (от Летниковской ул. до Дубининской ул.), д.19"
2,"Москва, ЦАО, Забелина ул. (пр. часть), пересечение со старосадским пер. д 11)"
3,"Москва, ЦАО, Ивановский М. пер., д.4"
...
```

Правила:

* Первая строка — заголовок `id,address`.
* Разделитель — запятая.
* Адрес желательно брать в кавычки `"..."`, особенно если внутри есть запятые.
* Файл должен быть сохранён в **кодировке Windows-1251 (cp1251)**
  (Excel на русском так и делает по умолчанию при «Сохранить как → CSV (разделители-запятые)»).

Если хочешь другое имя файла — поменяй константу `INPUT_CSV` в коде.

---

## Google API key

**Важно!** Никогда не коммить реальный ключ в публичный репозиторий.

Скрипт сейчас ожидает ключ в константе:

```python
GOOGLE_API_KEY = "ВАШ_API_KEY"
```

Рекомендованный вариант — читать его из переменной окружения и держать вне Git:

```python
import os

GOOGLE_API_KEY = os.environ.get("GOOGLE_API_KEY", "").strip()
if not GOOGLE_API_KEY:
    raise SystemExit("GOOGLE_API_KEY не задан. Установите переменную окружения.")
```

Тогда при запуске:

```bash
# Windows PowerShell
$env:GOOGLE_API_KEY = "your_real_key_here"
python geocode_google.py
```

Или прописать ключ в `.env`/секретах CI, но **не в коде**.

---

## Запуск

Обычный сценарий:

```bash
python geocode_google.py
```

Скрипт:

1. Открывает `addresses.csv` (cp1251).
2. Пропускает заголовок.
3. Для каждой строки:

   * парсит `id` и `address`,
   * пытается геокодировать полный адрес,
   * если Google возвращает `ZERO_RESULTS`, по очереди обрезает хвост по запятой и пробует снова,
   * в случае успеха пишет `lat,lng`,
   * в случае любой ошибки/отсутствия результата оставляет пустые координаты.
4. Результат пишет в `addresses_geocoded.csv` (также cp1251).

По ходу работы в консоль летят логи вида:

```text
[1] Москва, ЦАО, Жуков пр-д (...), д.19 -> 55.726945, 37.638346
    [try] 'Москва, ЦАО, что-то там, д.19' -> status=ZERO_RESULTS
    [fallback] нашёл по укороченному адресу: 'Москва, ЦАО, ...'
```

---

## Структура выходного файла

`addresses_geocoded.csv`:

```csv
id,address,lat,lng
1,"Москва, ЦАО, Жуков пр-д (от Летниковской ул. до Дубининской ул.), д.19",55.726945,37.638346
2,"Москва, ЦАО, Забелина ул. (пр. часть), пересечение со старосадским пер. д 11)",55.7548814,37.6386081
...
```

* `lat`/`lng` — пустые, если адрес не удалось геокодировать.
* Кодировка `cp1251`, чтобы файл без мучений открывался в Excel.

---

## Настройки

В начале файла есть блок:

```python
INPUT_CSV = "addresses.csv"
OUTPUT_CSV = "addresses_geocoded.csv"
GOOGLE_API_KEY = "..."   # см. раздел выше
DELAY_SEC = 0.2          # пауза между запросами
```

Можно под себя поменять имена файлов и интервал между запросами.

---

## Ограничения и предупреждения

* `verify=False` в `requests.get` отключает проверку TLS-сертификата.
  Это сделано специально, чтобы пережить self-signed сертификат в локальной инфраструктуре.
  В боевом интернете лучше использовать стандартный `verify=True`.
* За превышение лимитов/квоты Google может начать отвечать ошибками (`OVER_QUERY_LIMIT` и т.п.) — скрипт их просто логирует.
* Скрипт не делает кэширование: если гонять один и тот же файл много раз, он каждый раз будет ходить в API.

---

## Лицензия

Добавь сюда любую лицензию, которая тебе нравится: MIT / Apache-2.0 / BSD-3-Clause и т.п.

Пример для MIT:

```markdown
